{% extends "base.html" %}
{% load static %}

{% block title %}Séance #{{ seance.seance_id }} - Formatrix{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/apprenants/detail.css' %}">
{% endblock %}

{% block content %}
<div class="page-inner">
  <div class="page-header mb-4">
    <h1 class="page-title">Séance #{{ seance.seance_id }}</h1>
    <div class="ms-auto">
      <div class="btn-group">
        <a href="{% url 'seances:seance-update' seance.seance_id %}" class="btn btn-warning">
          <i class="fas fa-edit me-2"></i>Modifier
        </a>
        <a href="{% url 'seances:seance-list' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left me-2"></i>Retour
        </a>
      </div>
    </div>
  </div>

  <!-- Contrôles de statut -->
  {% if seance.statut == 'pas_commence' %}
  <div class="alert alert-warning d-flex align-items-center mb-4">
    <div class="me-3">
      <i class="fas fa-exclamation-triangle fa-2x"></i>
    </div>
    <div>
      <h4 class="mb-2">Séance non commencée</h4>
      <p class="mb-2">Cette séance n'a pas encore commencé. Vous pouvez la démarrer ou l'annuler.</p>
      <div class="mt-2">
        <button type="button" class="btn btn-success me-2" onclick="updateStatus('start')">
          <i class="fas fa-play me-2"></i>Commencer la séance
        </button>
        <button type="button" class="btn btn-danger" onclick="updateStatus('cancel')">
          <i class="fas fa-times me-2"></i>Annuler la séance
        </button>
      </div>
    </div>
  </div>
  {% elif seance.statut == 'en_cours' %}
  <div class="alert alert-success d-flex align-items-center mb-4">
    <div class="me-3">
      <i class="fas fa-clock fa-2x"></i>
    </div>
    <div>
      <h4 class="mb-2">Séance en cours</h4>
      <p class="mb-2">Cette séance est actuellement en cours. Vous pouvez la marquer comme terminée.</p>
      <div class="mt-2">
        <button type="button" class="btn btn-primary" onclick="updateStatus('complete')">
          <i class="fas fa-check me-2"></i>Terminer la séance
        </button>
      </div>
    </div>
  </div>
  {% elif seance.statut == 'termine' %}
  <div class="alert alert-primary d-flex align-items-center mb-4">
    <div class="me-3">
      <i class="fas fa-check-circle fa-2x"></i>
    </div>
    <div>
      <h4 class="mb-2">Séance terminée</h4>
      <p class="mb-0">Cette séance a été terminée le {{ seance.completed_at|date:"d/m/Y à H:i" }}.</p>
    </div>
  </div>
  {% elif seance.statut == 'annule' %}
  <div class="alert alert-danger d-flex align-items-center mb-4">
    <div class="me-3">
      <i class="fas fa-ban fa-2x"></i>
    </div>
    <div>
      <h4 class="mb-2">Séance annulée</h4>
      <p class="mb-0">Cette séance a été annulée.</p>
    </div>
  </div>
  {% endif %}

  <div class="row">
    <!-- Colonne de gauche -->
    <div class="col-md-6">
      <!-- Informations générales -->
      <div class="info-card">
        <div class="info-card-header">
          <i class="fas fa-info-circle me-2"></i>Informations générales
        </div>
        <div class="info-card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Cours</div>
                <div class="info-value">{{ seance.cours.nom_cours }}</div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Date</div>
                <div class="info-value">{{ seance.date|date:"d F Y" }}</div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Lieu</div>
                <div class="info-value">{{ seance.lieu.lieu }}</div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Statut</div>
                <div class="info-value">
                  <span class="badge {% if seance.statut == 'pas_commence' %}bg-warning{% elif seance.statut == 'en_cours' %}bg-success{% elif seance.statut == 'termine' %}bg-primary{% elif seance.statut == 'annule' %}bg-danger{% endif %}">
                    {% for code, label in status_choices %}
                      {% if code == seance.statut %}{{ label }}{% endif %}
                    {% endfor %}
                  </span>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Places</div>
                <div class="info-value">{{ seance.places_reservees }} / {{ seance.nombre_places }}</div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Prix</div>
                <div class="info-value">{{ seance.prix }} €</div>
              </div>
            </div>
            
            {% if seance.started_at %}
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Début</div>
                <div class="info-value">{{ seance.started_at|date:"d/m/Y H:i" }}</div>
              </div>
            </div>
            {% endif %}
            
            {% if seance.completed_at %}
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Fin</div>
                <div class="info-value">{{ seance.completed_at|date:"d/m/Y H:i" }}</div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Formateurs assignés -->
      <div class="info-card">
        <div class="info-card-header">
          <i class="fas fa-chalkboard-teacher me-2"></i>Formateurs assignés
        </div>
        <div class="info-card-body">
          {% if seance.formateurs.all %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Email</th>
                  <th>Téléphone</th>
                </tr>
              </thead>
              <tbody>
                {% for formateur in seance.formateurs.all %}
                <tr>
                  <td>{{ formateur.nom }} {{ formateur.prenom }}</td>
                  <td>{{ formateur.email }}</td>
                  <td>{{ formateur.telephone }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">Aucun formateur assigné à cette séance.</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Colonne de droite -->
    <div class="col-md-6">
      <!-- Informations sur le cours -->
      <div class="info-card">
        <div class="info-card-header">
          <i class="fas fa-book me-2"></i>Informations sur le cours
        </div>
        <div class="info-card-body">
          <div class="row">
            <div class="col-md-12">
              <div class="info-item">
                <div class="info-label">Nom du cours</div>
                <div class="info-value">{{ seance.cours.nom_cours }}</div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Durée</div>
                <div class="info-value">{{ seance.cours.duree }} heures</div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="info-item">
                <div class="info-label">Niveau</div>
                <div class="info-value">{{ seance.cours.niveau }}</div>
              </div>
            </div>
            
            {% if seance.cours.description %}
            <div class="col-md-12">
              <div class="info-item">
                <div class="info-label">Description</div>
                <div class="info-value">{{ seance.cours.description }}</div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Absences et remplacements -->
      <div class="info-card">
        <div class="info-card-header d-flex justify-content-between align-items-center">
          <div>
            <i class="fas fa-user-clock me-2"></i>Absences et remplacements
          </div>
          <a href="{% url 'seances:absence_create' seance.seance_id %}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-1"></i>Signaler une absence
          </a>
        </div>
        <div class="info-card-body">
          {% if absences %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Formateur</th>
                  <th>Date</th>
                  <th>Raison</th>
                  <th>Remplaçant</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for absence in absences %}
                <tr>
                  <td>{{ absence.formateur_absent.nom }} {{ absence.formateur_absent.prenom }}</td>
                  <td>{{ absence.date_absence|date:"d/m/Y" }}</td>
                  <td>{{ absence.get_raison_display }}</td>
                  <td>
                    {% if absence.formateur_remplacant %}
                    {{ absence.formateur_remplacant.nom }} {{ absence.formateur_remplacant.prenom }}
                    {% else %}
                    <span class="text-muted">Non remplacé</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group">
                      <a href="{% url 'seances:absence_update' absence.absence_id %}" class="btn btn-sm btn-warning" title="Modifier">
                        <i class="fas fa-edit"></i>
                      </a>
                      <a href="{% url 'seances:absence_delete' absence.absence_id %}" class="btn btn-sm btn-danger" title="Supprimer">
                        <i class="fas fa-trash"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">Aucune absence signalée pour cette séance.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <div class="d-flex justify-content-between mt-3">
    <a href="{% url 'seances:seance-list' %}" class="btn btn-secondary">
      <i class="fas fa-arrow-left me-2"></i>Retour à la liste
    </a>
    <div>
      <a href="{% url 'seances:seance-update' seance.seance_id %}" class="btn btn-warning">
        <i class="fas fa-edit me-2"></i>Modifier
      </a>
      <a href="{% url 'seances:seance-delete' seance.seance_id %}" class="btn btn-danger ms-2">
        <i class="fas fa-trash me-2"></i>Supprimer
      </a>
    </div>
  </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateStatus(action) {
    if (!confirm(`Êtes-vous sûr de vouloir ${action === 'start' ? 'commencer' : action === 'complete' ? 'terminer' : 'annuler'} cette séance ?`)) {
        return;
    }

    const csrftoken = getCookie('csrftoken');
    
    fetch(`/seances/{{ seance.seance_id }}/${action}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur lors de la mise à jour du statut');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Recharger la page pour afficher les changements
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de la mise à jour du statut.');
    });
}
</script>
{% endblock %}